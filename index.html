<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Monitoreo de Erosi√≥n (Offline)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0ea5e9">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    header { display:flex; align-items:center; gap:8px; }
    h1 { font-size: 1.2rem; margin: 0; }
    fieldset { border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:12px; }
    legend { padding:0 6px; color:#2563eb; }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    select, input[type="text"], input[type="file"], button { width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#f1f5f9; }
    .ok { background:#dcfce7; }
    .warn { background:#ffedd5; }
    .list { margin-top:12px; }
    .card { border:1px solid #e5e7eb; border-radius:8px; padding:10px; margin-bottom:8px; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <header>
    <h1>Monitoreo de Erosi√≥n (Offline)</h1>
    <span id="status" class="pill">Cargando‚Ä¶</span>
  </header>

  <form id="form">
    <fieldset>
      <legend>Identificaci√≥n <span style="color:#ef4444">*</span></legend>
      <div class="row">
        <div>
          <label for="torre">Torre *</label>
          <input id="torre" name="torre" required>
        </div>
        <div>
          <label for="camino">Camino *</label>
          <input id="camino" name="camino" required>
        </div>
      </div>
     <div class="row">
  <div>
    <label for="fecha">Fecha *</label>
    <input id="fecha" name="fecha" type="date" required>
  </div>
  <div>
    <label for="tramo">Tramo *</label>
    <input id="tramo" name="tramo" required>
  </div>
</div>

<div class="row">
  <div>
    <label for="exposicion">Exposici√≥n</label>
    <select id="exposicion" name="exposicion"></select>
  </div>
</div>
    </fieldset>

    <fieldset>
      <legend>Suelo</legend>
      <div class="row">
        <div>
          <label for="textura">Textura</label>
          <select id="textura" name="textura"></select>
        </div>
        <div>
          <label for="pendiente">Pendiente (%)</label>
          <select id="pendiente" name="pendiente"></select>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Par√°metros para IET</legend>
      <div class="row">
        <div>
          <label for="suelo_perdido">% de suelo perdido (c√≥digo)</label>
          <select id="suelo_perdido" name="suelo_perdido"></select>
        </div>
        <div>
          <label for="cobertura">Cobertura vegetacional (c√≥digo)</label>
          <select id="cobertura" name="cobertura"></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="pedestales">Pedestales (c√≥digo)</label>
          <select id="pedestales" name="pedestales"></select>
        </div>
        <div>
          <label for="pavimentos">Pavimentos de erosi√≥n (c√≥digo)</label>
          <select id="pavimentos" name="pavimentos"></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="costras">Costras (c√≥digo)</label>
          <select id="costras" name="costras"></select>
        </div>
        <div>
          <label for="surcos">Surcos o C√°rcavas (c√≥digo)</label>
          <select id="surcos" name="surcos"></select>
        </div>
      </div>
      <div>
        <label for="canaliculos">Canal√≠culos o regueros (c√≥digo)</label>
        <select id="canaliculos" name="canaliculos"></select>
      </div>
      <div class="row">
        <div>
          <label>IET (auto)</label>
          <input id="iet" name="iet" readonly>
        </div>
        <div>
          <label>Clase de erosi√≥n (auto)</label>
          <input id="clase" name="clase" readonly>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Ubicaci√≥n y evidencia</legend>
      <div class="row">
        <div>
          <label for="ubicacion">Coordenadas (lat,lon)</label>
          <input id="ubicacion" name="ubicacion" placeholder="-33.4,-70.6" readonly>
        </div>
        <div>
          <label>&nbsp;</label>
          <button type="button" id="btnGPS">Tomar ubicaci√≥n</button>
        </div>
      </div>
      <div>
        <label for="foto">Foto (obligatoria) *</label>
        <input id="foto" name="foto" type="file" accept="image/*" capture="environment" required>
        <small>En iPhone: autoriza el uso de c√°mara.</small>
      </div>
    </fieldset>

    <div class="actions">
      <button type="submit">Guardar en el dispositivo</button>
      <button type="button" id="export">Exportar CSV</button>
      <button type="button" id="clear">Borrar todo (local)</button>
    </div>
  </form>

  <section class="list">
    <h3>Registros guardados (offline)</h3>
    <div id="registros"></div>
  </section>

<script>
// -- Estado online/offline
const statusEl = document.getElementById('status');
function setStatus(txt, cls='pill'){ statusEl.textContent = txt; statusEl.className = cls; }
setStatus(navigator.onLine ? 'En l√≠nea' : 'Sin conexi√≥n', 'pill ' + (navigator.onLine ? 'ok':'warn'));
window.addEventListener('online',  ()=> setStatus('En l√≠nea','pill ok'));
window.addEventListener('offline', ()=> setStatus('Sin conexi√≥n','pill warn'));

// -- Cargar listas (cat√°logos) desde choices.json
async function loadChoices(){ 
  const res = await fetch('./choices.json');   // üëà importante el ./ 
  return res.json();
}
function fillSelect(id, list){
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">‚Äî Seleccione ‚Äî</option>' +
    list.map(o => `<option value="${o.code}">${o.label}</option>`).join('');
}

let CHOICES = null;
loadChoices().then(c => {
  CHOICES = c;
  ['textura','exposicion','pendiente','suelo_perdido','cobertura','pedestales','pavimentos','costras','surcos','canaliculos']
    .forEach(key => fillSelect(key, CHOICES[key]));
});

// -- C√°lculo IET (promedio de >0 entre 7 campos)
const IET_FIELDS = ['suelo_perdido','cobertura','pedestales','pavimentos','costras','surcos','canaliculos'];
function num(v){ const n = Number(v); return isNaN(n) ? 0 : n; }
function ietFrom(form){
  let sum=0, cnt=0;
  for (const k of IET_FIELDS){
    const v = num(form[k].value);
    if (v > 0){ sum += v; cnt += 1; }
  }
  if (cnt === 0) return '';
  return Math.round((sum/cnt)*10)/10;
}
function claseFrom(iet){
  if (iet==='') return '';
  if (iet < 1.5)  return 'Erosi√≥n ligera';
  if (iet < 2.5)  return 'Erosi√≥n moderada';
  if (iet < 3.25) return 'Erosi√≥n severa';
  return 'Erosi√≥n muy severa';
}

const form = document.getElementById('form');
  // Prefill hoy (YYYY-MM-DD)
(function setToday(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const today = `${yyyy}-${mm}-${dd}`;
  const f = document.getElementById('fecha');
  if (f && !f.value) f.value = today;
})();

form.addEventListener('change', () => {
  const iet = ietFrom(form);
  document.getElementById('iet').value   = iet;
  document.getElementById('clase').value = claseFrom(iet);
});

// -- GPS
document.getElementById('btnGPS').addEventListener('click', () => {
  if (!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    document.getElementById('ubicacion').value = latitude.toFixed(6)+','+longitude.toFixed(6);
  }, err => {
    alert('No se pudo obtener GPS: ' + err.message);
  }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
});

// -- IndexedDB (almacenamiento offline)
let db;
const DB_NAME = 'erosion-db';
const STORE   = 'registros';

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => { e.target.result.createObjectStore(STORE, { keyPath:'id' }); };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror   = e => reject(e);
  });
}
async function initDB(){ db = await openDB(); listRegistros(); }
initDB();

async function saveRegistro(obj){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction([STORE], 'readwrite');
    tx.objectStore(STORE).put(obj);
    tx.oncomplete = () => resolve();
    tx.onerror    = e  => reject(e);
  });
}
async function getAll(){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction([STORE], 'readonly');
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror   = e  => reject(e);
  });
}
async function clearAll(){
  return new Promise((resolve,reject)=>{
    const tx = db.transaction([STORE], 'readwrite');
    tx.objectStore(STORE).clear();
    tx.oncomplete = () => resolve();
    tx.onerror    = e  => reject(e);
  });
}

// -- Guardar registro (con validaciones)
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!form.torre.value || !form.camino.value || !form.tramo.value){ alert('Torre, Camino y Tramo son obligatorios'); return; }
  if (!form.foto.files[0]){ alert('La foto es obligatoria'); return; }

  const file = form.foto.files[0];
  const photoBase64 = await new Promise(res => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result);
    reader.readAsDataURL(file);
  });

  const iet = ietFrom(form);
  const data = {
    id: (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + '-' + Math.random())),
    fecha: form.fecha.value,      // üëà NUEVO
    ts: new Date().toISOString(),
    torre: form.torre.value,
    camino: form.camino.value,
    tramo: form.tramo.value,
    ...
  };


    id: (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+'-'+Math.random())),
    ts: new Date().toISOString(),
    torre: form.torre.value,
    camino: form.camino.value,
    tramo: form.tramo.value,
    exposicion: form.exposicion.value,
    textura: form.textura.value,
    pendiente: form.pendiente.value,
    suelo_perdido: form.suelo_perdido.value,
    cobertura: form.cobertura.value,
    pedestales: form.pedestales.value,
    pavimentos: form.pavimentos.value,
    costras: form.costras.value,
    surcos: form.surcos.value,
    canaliculos: form.canaliculos.value,
    ubicacion: form.ubicacion.value,
    iet: iet,
    clase: claseFrom(iet),
    foto_name: file.name,
    foto_dataurl: photoBase64
  };
  await saveRegistro(data);
  form.reset();
  document.getElementById('iet').value = '';
  document.getElementById('clase').value = '';
  listRegistros();
  alert('Guardado en el dispositivo.');
});

// -- Listado y exportaci√≥n
async function listRegistros(){
  const list = document.getElementById('registros');
  const all = await getAll();
  if (all.length===0){ list.innerHTML = '<p>No hay registros a√∫n.</p>'; return; }
  list.innerHTML = all.map(r => `<div class="card">
    <div><strong>${r.torre}</strong> ‚Äî ${r.camino} / ${r.tramo} ‚Äî <em>${r.fecha || ''}</em></div>
    <div><small class="mono">${r.ts}</small></div>
    <div>IET: <strong>${r.iet || '-'}</strong> | Clase: <strong>${r.clase || '-'}</strong></div>
    <div>GPS: ${r.ubicacion || '-'}</div>
  </div>`).join('');
}

document.getElementById('export').addEventListener('click', async ()=>{
  const all = await getAll();
  const headers = ["id","ts","fecha","torre","camino","tramo","exposicion","textura","pendiente","suelo_perdido","cobertura","pedestales","pavimentos","costras","surcos","canaliculos","ubicacion","iet","clase","foto_name"];
  const rows = [headers.join(',')].concat(all.map(r => headers.map(h => (''+(r[h] ?? '')).replace(/,/g,';')).join(',')));
  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8'});
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'registros_erosion.csv'; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('clear').addEventListener('click', async ()=>{
  if (confirm('Esto borrar√° todos los registros guardados localmente. ¬øSeguro?')){
    await clearAll();
    listRegistros();
  }
});

// -- Registrar service worker (modo offline)
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
}
</script>

</body>
</html>
